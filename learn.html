# 我遇到和踩过的坑



1. 二方库冲突。onetouch-hecate分拆为四大金刚（dionysus、gaea、circe、zeus）时，basedata-client分拆为四个子应用的client，并改了pom坐标，但是client的代码是平移的。这样做的考虑是：各子应用要升级修改client时，只需要修改本应用的client，不用再到hecate中改basedata-client，但带来的后果是，同构不同坐标的二方库带来了大量的jar包依赖冲突（和集团发布的以com.alibaba.external开头的二方库一样），后患无穷。永远不要将dionysus-client对外使用，只在本应用内部用。后续在基础二方库拆分时，也犯了同样的错，本意是希望不更换包路径，减少对使用方的侵入，但却带来了另一个更大的问题。我的体会是：架构设计要综合权衡考虑多种因素，如果一个方案是：初期对用户没有损害，但是带来长期存在的坑，另一个方案是初期推动接入切换的成本较大，但是没有后患，那推进用第二个方案，因为长痛不如短痛，技改一定要彻底不留尾巴。
2. 通用拦截器。boss系统在构建初期，要在切面统一拦截hsf服务调用和web rpc调用，用于发送通用业务消息给流程中心。当时我感觉这样会导致大量的notify消息泛滥，并且在应用底层悄悄做这种黑技术，很容易为以后埋坑，对此方案比较抵触，但是架构师说一达通业务体量这么小，不会有多少消息，我还是执行了。但是随着业务发展，从boss发展到mo、拍档，所有的hsf调用都会发消息，有时业务系统夜间跑任务，大量的消息泛滥，更致命的是，当想调整发送策略时，同一个二方库被十几个系统大量依赖，要修改或下掉非常困难。这种设计，原本是希望通过组件复用，减少各业务系统的重复工作，但是中心化设计没有考虑灵活性和扩展性，也没有考虑性能因素，架构是变化的，不能只基于现状做决策，系统要为未来的不确定性预留足够的容忍度空间
3. 理解和处理跨领域的模型差异。在客户领域，一达通与CRM、ICBU有密切的交互。一达通的客户模型与会员模型、Leads模型focus的业务场景有较大差异，而一达通很多业务产品功能将这几者糅合在一起，导致引发了很多无法解决的系统问题。譬如，一达通做物流客户准入时，业务方希望将无认证的会员自动生成一达通客户，当时很抵触该方案，感觉这两个领域搅在一起会有很大问题，但是说不清楚具体后果，还是硬着头皮做了，后来引发的后果是脏客户数据的修复带来了极大困难。我的体会是：工程师要有自己的思考，架构立场要坚定，不要去做违心的事情。
4. 业务与中台关系。技术在业务发展过程中经常会被中台的边界问题所困扰和束缚。例如在建设运营平台、画像系统、拍档crm过程中，都遇到了这种困惑。中台提供的通用能力可以满足一些业务需求，对于个性化的业务需求无法支撑，这时候，一方面中台不允许业务线自立门户重设计一套，哪怕业务线是用很轻量的方式快速搭建一个适用于自己的平台也会被挑战；另一方面，中台答应排期扩展支撑业务线的个性化需求，但是遥遥无期，很不灵动，这使得业务非常被动，技术也很无助。这种风气非常不好，建议集团对中台要辩证看待，不能一刀切，不然技术支撑业务这个目标无法达到。
5. 慎用鹰眼。dao层采用鹰眼传递上下文自动保存操作人，很好的拓展了原二方库的dao在分布式环境的可用范围。但是这是个取巧的方案，只能用在一些非正式的弱场景下，如果用在业务流程中，就会使系统变成一个黑洞，遇到问题难以维护和排查，而且后面发现鹰眼对字符串长度有限制，超长会截断。我的体会是：在系统设计过程中，还是要“本份”些，不要有太多自作聪明的方案，架构方案要考虑后面维护成本。
6. 避免提供通用泛化接口。一达通在boss重构初期提供的通用查询api（corebaseservice的queryForList和存在sql注入风险的Queryservice）被人诟病已久，产生了极其恶劣的影响，时至至今未能收拾干净。这个问题再次提出，是为了再次警示所有人。当时架构的出发点是：这些系统是针对500＋小二使用的，并发量和数据量都不大；通用api可节省开发人力。后来的事情都知道了，业务发展从boss拓展了mo，系统数据量和并发已不是最初臆想那样，没有收敛的api开放出去后就像洪水泛滥，使整个系统暴露在风险之中，无法控制，多次故障和技改都是血淋淋的教训。我的感触是：在任何场景下，服务的设计都要考虑性能，不能提供万能接口
7. 服务的自我保护。一达通历史上出现过几次因为没对sql查询条件做限制，导致查询命中全表数据，一次加载到内存造成oom。这是非常低级的错误，但业界很多开发同学因为种种原因总是难以避免。当遇到这种不能预期数据库返回记录数量的情况，一个有效的做法是在查询层要对数据库返回记录数做限制。归根结底，技术人员在提供服务时，一定要多思考，自我保护，就是让应用对极端情况具备一定的免疫力，出问题时降低影响面，而不是及整个应用。
8. 全局架构观。在做单体应用服务化拆分方案时，设计了比较完善的切换计划，但在灰度发布上线中，突然发现有很多服务调用失败，后排查原因发现在方案中忽略了一点：新服务虽从老服务平移过来，但是扩展了老服务的能力，后者是前者的子集，所以两者不是对等的，不能兼容，即不能互相调用。在灰度发布过程中，新、老服务同时在线，如果新应用调用到老应用，会出现找不到调用api的错误。所幸我们紧急应对有了新方案，通过将新老服务归组到不同的hsf group解决了问题。后面对此进行深刻反思，其实最初在方案设计时也考虑了新老服务的兼容问题，但是只意识到老应用可以调新应用，却忽视了在上线过程中，由于老服务未完全停掉，会出现新应用调到老应用的情况。给我的教训是，技术人员在设计技术架构方案一定要反复推敲，既要有全局思维，也要有严谨的态度，既要考虑终态，也要考虑每个过程节点的状态，不能有丝毫大意。
9. 谨慎开放粗力度api。设计联系人模型时，为支持多种类型的联系人（产品、订单、客户）复用，设计了一个通用联系人表，用联系人类别属性进行区分。在对外提供api时，将联系人类别开放给调用方进行设置，同时系统没有任何校验，导致存储数据非常混乱，而且有引发冲突的风险。对此进行反思：将不同联系人统一存储，在底层通过类型区分的设计方案本身是没错的，上述做法错在将领域的实现细节逻辑以API形式对外暴露，带来的坏处是：调用方随意设置联系人类别这一关键属性，可能导致数据混乱；更严重的是，后续如果不同类别联系人要分开存储，那么当前提供的通用接口就无法继续维护和扩展。给我的启发是：任何时候务必对外提供更有语义场景的接口，绝不把领域实现细节暴露给调用方。
10. 谨慎使用数据冗余。当跨团队的数据需集中在统一列表展现给用户时，有一种方案是冗余存储其他业务域的数据。一达通在与外部合作过程中，有几次采用了该方案，一个是双审环节冗余产品、开票人数据，一个是拍档crm冗余客户拍档关系，带来了无穷的后患。通过消息监听或接口双写进行数据同步，都不是可靠的，因为消息可能会漏发或消费失败，同时因系统又没保证分布式事务导致数据双写失败，另外数据订正的场景会带来更多不一致。我认为数据冗余只适用于一些可变性不大的非关键场景，对于核心业务数据尽量避免冗余，因为排查数据不一致问题的代价会远远超出你想象。如果一定要冗余，需要有完备的数据一致性保证方案和监控方案。

